GOPATH ?= $(shell go env GOPATH)
GOPATH_BIN := $(GOPATH)/bin
HERTZ_VERSION := v0.8.0
HERTZ := $(GOPATH_BIN)/hz-$(HERTZ_VERSION)
THRIFTFMT_VERSION := v0.0.8
THRIFTFMT := $(GOPATH_BIN)/thriftfmt-$(THRIFTFMT_VERSION)
THRIFTGO_VERSION := v0.3.4
THRIFTGO := $(GOPATH_BIN)/thriftgo-$(THRIFTGO_VERSION)
GOLANGCI_LINT_VERSION := v1.53.3
GOLANGCI_LINT := $(GOPATH_BIN)/golangci-lint-$(GOLANGCI_LINT_VERSION)
GOMOCK_VERSION := v1.5.0
GOMOCK := $(GOPATH_BIN)/mockgen-$(GOMOCK_VERSION)


init_grpc:
	go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
	go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

gen_grpc: init_grpc
	protoc --proto_path=idl \
		   --go_out=biz/model/ \
		   --go_opt=paths=source_relative \
		   --go-grpc_out=biz/model/ \
		   --go-grpc_opt=paths=source_relative \
		   idl/*

update_backtest_proto:
	hz update -I idl/backtest.proto -idl idl/backtest.proto

update_tracker_proto:
	hz update -I idl/tracker.proto -idl idl/tracker.proto

# 构建相关变量
MODULE := $(shell awk 'NR==1 {print $$2}' go.mod)
APP_NAME := xquant
BUILD_BIN_DIR := bin
GOOS := $(shell go env GOOS)
GOARCH := $(shell go env GOARCH)
GOVERSION := $(shell go env GOVERSION)
GIT_TAG := $(shell git describe --tags `git rev-list --tags --max-count=1` 2>/dev/null || echo "v0.0.0")
VERSION := $(shell echo $(GIT_TAG) | sed 's/^v//' || echo "0.0.0")

# 显示环境信息
.PHONY: env
env:
	@echo "----------------< go env >----------------"
	@echo "   GOOS: $(GOOS)"
	@echo " GOARCH: $(GOARCH)"
	@echo "version: $(shell echo $(GOVERSION) | sed 's/^go//')"
	@echo "----------------< project >----------------"
	@echo " go mod: $(MODULE)"
	@echo "version: $(VERSION)"
	@echo " author: $(shell git log $(GIT_TAG) --pretty=format:"%an" 2>/dev/null | sed -n 1p || echo "unknown")"

# 创建 bin 目录
$(BUILD_BIN_DIR):
	@mkdir -p $(BUILD_BIN_DIR)

# 构建应用
.PHONY: build
build: env $(BUILD_BIN_DIR)
	@echo "----------------< compile >----------------"
	@echo "   GOOS: $(GOOS)"
	@echo " GOARCH: $(GOARCH)"
	@echo "正在编译应用:$(APP_NAME) => $(BUILD_BIN_DIR)/$(APP_NAME)..."
	@GO111MODULE=auto GOPRIVATE=gitee.com GOPROXY=https://goproxy.cn,direct \
	go build -ldflags "-s -w -X 'main.MinVersion=$(VERSION)'" \
		-o $(BUILD_BIN_DIR)/$(APP_NAME) $(MODULE)
	@echo "正在编译应用:$(APP_NAME) => $(BUILD_BIN_DIR)/$(APP_NAME)...OK"

# 构建 Linux 版本
.PHONY: build-linux
build-linux: $(BUILD_BIN_DIR)
	@echo "----------------< compile linux >----------------"
	@GOOS=linux GOARCH=amd64 GO111MODULE=auto GOPRIVATE=gitee.com GOPROXY=https://goproxy.cn,direct \
	go build -ldflags "-s -w -X 'main.MinVersion=$(VERSION)'" \
		-o $(BUILD_BIN_DIR)/$(APP_NAME)-linux-amd64 $(MODULE)
	@echo "正在编译应用:$(APP_NAME) => $(BUILD_BIN_DIR)/$(APP_NAME)-linux-amd64...OK"

# 构建 Windows 版本
.PHONY: build-windows
build-windows: $(BUILD_BIN_DIR)
	@echo "----------------< compile windows >----------------"
	@GOOS=windows GOARCH=amd64 GO111MODULE=auto GOPRIVATE=gitee.com GOPROXY=https://goproxy.cn,direct \
	go build -ldflags "-s -w -X 'main.MinVersion=$(VERSION)'" \
		-o $(BUILD_BIN_DIR)/$(APP_NAME)-windows-amd64.exe $(MODULE)
	@echo "正在编译应用:$(APP_NAME) => $(BUILD_BIN_DIR)/$(APP_NAME)-windows-amd64.exe...OK"

# 构建 macOS 版本
.PHONY: build-darwin
build-darwin: $(BUILD_BIN_DIR)
	@echo "----------------< compile darwin >----------------"
	@GOOS=darwin GOARCH=amd64 GO111MODULE=auto GOPRIVATE=gitee.com GOPROXY=https://goproxy.cn,direct \
	go build -ldflags "-s -w -X 'main.MinVersion=$(VERSION)'" \
		-o $(BUILD_BIN_DIR)/$(APP_NAME)-darwin-amd64 $(MODULE)
	@echo "正在编译应用:$(APP_NAME) => $(BUILD_BIN_DIR)/$(APP_NAME)-darwin-amd64...OK"

# 构建所有平台版本
.PHONY: build-all
build-all: build-linux build-windows build-darwin
	@echo "所有平台构建完成"

# 清理构建产物
.PHONY: clean
clean:
	@rm -rf $(BUILD_BIN_DIR)
	@echo "清理完成"